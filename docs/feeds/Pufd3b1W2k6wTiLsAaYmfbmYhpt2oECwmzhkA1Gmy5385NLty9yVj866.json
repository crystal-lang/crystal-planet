{"id":"Pufd3b1W2k6wTiLsAaYmfbmYhpt2oECwmzhkA1Gmy5385NLty9yVj866","title":"Crystal Forum - Latest topics","displayTitle":"Forum","url":"https://forum.crystal-lang.org/latest.rss","feedLink":"https://forum.crystal-lang.org/latest","isQuery":false,"isEmpty":false,"isHidden":false,"itemCount":30,"items":[{"title":"Loading ECR templates at runtime*","url":"https://forum.crystal-lang.org/t/loading-ecr-templates-at-runtime/8546","date":1763449099,"author":"willhbr","guid":35,"unread":true,"content":"<p>I‚Äôve been doing a bit of a dive into how ECR works, and ended up implementing a way to reload the non-code parts of ECR files at runtime. This means you can make an HTML template, tweak styles/layout and see the changes immediately, so long as you don‚Äôt touch any Crystal code in the template.</p><p>Once I knew how ECR works (it‚Äôs really cool!) I realised <a href=\"https://willhbr.net/2025/11/17/hot-ecr-reloading-in-your-area/\" rel=\"noopener nofollow ugc\">I could load the template-y parts of the ECR file at runtime</a>, which gives me most of the benefit of runtime templates while still being able to compile to efficient code (sans hot reloading) on a release build. That post also has a bit of explanation on why ECR is so cool.</p><p>Hopefully someone finds this useful or my explanations interesting!</p>","contentLength":696,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"New shard, kemal-controller","url":"https://forum.crystal-lang.org/t/new-shard-kemal-controller/8545","date":1763406207,"author":"hugopl","guid":34,"unread":true,"content":"<p>I‚Äôm used to the rails way of doing a MVC web applications, so every time I was doing something with Kemal I had the felling of missing something, yes, a controller class.</p><p>This shard does that, it add a way to write Kemal routes in a controller class (struct in fact), but the most interesting thing it does IMO is to map the HTTP/Route parameters into method parameters, example:</p><pre data-code-wrap=\"crystal\"><code>struct UsersController &lt; Kemal::Controller\n  @[Get(\"/users\")]\n  def index\n    \"Listing all users\"\n  end\n\n  @[Get(\"/users/:id\")]\n  def show(id : Int32)\n    \"Showing user with ID: #{id}\"\n  end\n\n  @[Post(\"/users\", auth: true)]\n  def create(name : String, age : Int32, description : String?))\n    \"Creating user with name: #{name}, age: #{age} and description: #{description}\"\n  end\n\n  private def authenticate! : Bool\n    true\n  end\nend\n</code></pre><p>Not a single release yep, API isn‚Äôt stable but may not have radical changes, meanwhile I‚Äôm using it in a not yet released project to test the API.</p>","contentLength":964,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"OptionParser : conditional option","url":"https://forum.crystal-lang.org/t/optionparser-conditional-option/8544","date":1763318594,"author":"hutou","guid":33,"unread":true,"content":"<p>Hi,\nIn OptionParser, would it be possible to have an option B depending on another option A, giving an error if option A is missing?</p>","contentLength":132,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Hello, Crystal Community üëãüèº!","url":"https://forum.crystal-lang.org/t/hello-crystal-community/8543","date":1763272414,"author":"omarluq","guid":32,"unread":true,"content":"<p>I‚Äôm Omar, a Senior DevOps Engineer in Austin, TX. I spend most of my days in the Kubernetes and Go world, so picking up Crystal has been a really refreshing shift, especially since I‚Äôve always been a Rubyist at heart.</p><p>I recently started hacking on a minimalist terminal I/O library for building TUI‚Äôs in Crystal, and I‚Äôve been having a great time with it. This language is seriously a joy to use.</p><p>Excited to learn, share, and meet everyone here.</p>","contentLength":451,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"File reads, reversing a slice","url":"https://forum.crystal-lang.org/t/file-reads-reversing-a-slice/8542","date":1763071270,"author":"BloodFeastMan","guid":31,"unread":true,"content":"<p>Playing with file reads / writes, so this loop will read from an input file and write to an output file:</p><pre><code>loop do\n\tbuf = Slice(UInt8).new(4096)\n\tn = infile.read(buf)\n\tbreak if n == 0\n\toutfile.write(buf[0...n])\nend\n</code></pre><p>All is fine, the output file hashes correctly.</p><p>If I place a  in there:</p><pre><code>loop do\n\tbuf = Slice(UInt8).new(4096)\n\tn = infile.read(buf)\n\tbreak if n == 0\n\tbuf.reverse!\n\toutfile.write(buf[0...n])\nend\n</code></pre><p>.. and run it twice, first on an input file, and then on the file that the first run produced, I would have thought that I would be back to my starting point, but the final result (after running it twice) does not hash correctly, and the contents are jibberish.</p><p>If I then manually count the input file size and set the  accordingly:</p><pre><code>loop do\n\tread_length = do_length(fsize)\n\tbuf = Slice(UInt8).new(read_length)\n\tn = infile.read(buf)\n\tbreak if n == 0\n\tbuf.reverse!\n\toutfile.write(buf[0...n])\n\tfsize -= read_length\nend\n</code></pre><pre><code>if infile_size &lt; 4096 # infile_size counts down in the above loop\n\tread_length = infile_size\nelse\n\tread_length = 4096\nend\n</code></pre><p>Now it will give me my expected result, i.e., if I run it twice, once on an input file and that on that output, I‚Äôm back to the same hash as the original input, which is interesting, as only the last slice read would not be 4096, furthermore,   be an exponential growth of 8, i.e., 1024, 2048, 4096, as a random multiple of 8 will give trash results. As an example, 3072 does not work.</p><p>This snippet doesn‚Äôt actually do anything useful, just an interesting observation from a hobbyist, and  I‚Äôm sure there‚Äôs an explanation.</p>","contentLength":1568,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Restricting options in CLI app","url":"https://forum.crystal-lang.org/t/restricting-options-in-cli-app/8541","date":1762947369,"author":"hutou","guid":30,"unread":true,"content":"<p>A CLI app I am working on has the following syntax in the command line:<code>appname command subcommand args</code></p><p>I‚Äôm using OptionParser and I‚Äôd wand to restrict some option at app level or the command level, for example:<code>appname --option1 command  --option2 subcommand</code></p><p>so that I‚Äôd prevent option1 to be used after command or subcommand, and option2 used before command.</p>","contentLength":362,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"VS Code Ameba Extension v0.3.0 Released","url":"https://forum.crystal-lang.org/t/vs-code-ameba-extension-v0-3-0-released/8540","date":1762831593,"author":"nobodywasishere","guid":29,"unread":true,"content":"<p>What's Changed\n\nAdd link to documentation by @nobodywasishere in #146\nMove to CancellationToken, Use spawn instead of exec, Add output channel for logging by @nobodywasishere in #147\nReload diagnos...</p>","contentLength":200,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Question about inheritence","url":"https://forum.crystal-lang.org/t/question-about-inheritence/8538","date":1762442784,"author":"Fulgurance","guid":28,"unread":true,"content":"<p>Hi guys, today I did this small test for the need of my project.</p><p>I would like to understand why the result is false ?</p><pre data-code-wrap=\"crystal\"><code>class Mother\n\n    def self.isDaughter : Bool\n        return self.class == Daughter\n    end\n\nend\n\nclass Daughter &lt; Mother\nend\n\nputs Daughter.isDaughter\n</code></pre>","contentLength":267,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Zensical ‚Äì A modern static site generator built by the Material for MkDocs team","url":"https://forum.crystal-lang.org/t/zensical-a-modern-static-site-generator-built-by-the-material-for-mkdocs-team/8534","date":1762361001,"author":"Fryguy","guid":27,"unread":true,"content":"<p>We are thrilled to announce Zensical, our next-gen static site generator that addresses and overcomes the technical limitations of MkDocs</p>","contentLength":137,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Eliminate environment modifications","url":"https://forum.crystal-lang.org/t/eliminate-environment-modifications/8533","date":1762333848,"author":"straight-shoota","guid":26,"unread":true,"content":"<p>Modifying a process‚Äô environment is generally not thread-safe because it is memory shared between all threads of a process.\nSystem functions like  or  are based on a global variable ( on unix systems). When a thread updates the environment configuration, it may reallocate the memory. Thus, any other thread which had previously obtained the pointer before the update and is now reading from the old memory, may be left with corrupt data.</p><p>We could offer some mitigation by synchronizing access through Crystal‚Äôs  interface.\nHowever, that would still not be 100% safe because it cannot account for direct access via the system APIs.</p><p>But maybe there‚Äôs a simpler solution: Disallow environment modifications, i.e. deprecate .</p><p>This idea is based on this hypothesis:</p><blockquote><p>Unless your process is a shell or adjacent, it shouldn‚Äôt need to mutate its environment.</p></blockquote><p>We‚Äôd need to look a bit more closely at specific use cases, but I think this might be a valid option.</p><p>It should be feasible to keep the functionality of  available in a portable interface, but with an explicit warning that it‚Äôs potentially unsafe (e.g. ).</p><p>Safe usage could only be guaranteed in a single-threaded process. It should be safe to set environment variables at the start of a multi-threaded process, before it spawns any other threads.</p><p>A common usage pattern is when you need to adjust the environment for a piece of code that you cannot configure directly but depends on environment variables.</p><p>This is primarily relevant for testing code that is supposed to react to environment settings. For example, we test several features in the standard library and compiler using the <a href=\"https://github.com/crystal-lang/crystal/blob/b91228b43268771dbeb496a1d140fe05a3875f6c/spec/support/env.cr\"> helper</a>.\nThis functionality seems reasonable and relevant.<p>\nBut instead of modifying the process‚Äô environment, we could mock it using a fiber-local overlay in the </p> interface.\nIn some cases, it might even be sufficient to just pass in configuration as explicit arguments.</p><p>I‚Äôm not aware of any specific other use cases. But I could expect instances where you need to modify the environment for calling a library methods which are not using Crystal‚Äôs  interface and thus  to read from the actual process environment.\nThat generally smells like bad design, but there might be some use cases.</p><p>I‚Äôm posting this thread to ask for feedback and examples.</p><p><small>29 posts - 10 participants</small></p>","contentLength":2316,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Yet another spin-off shard: ralsina/docopt-config","url":"https://forum.crystal-lang.org/t/yet-another-spin-off-shard-ralsina-docopt-config/8528","date":1762184699,"author":"ralsina","guid":25,"unread":true,"content":"<p>I like using docopt in my CLI tools because it means the docs are always correct. However once you want to support other means of config like config files and env vars, docopt has no support.</p><p>UNTIL NOW with <a href=\"https://github.com/ralsina/docopt-config\" rel=\"noopener nofollow ugc\">ralsina/docopt-config</a> where you get it all for free. Just write your docopt and use docopt_config instead of docopt and It Just Works.</p><p>Zero config. A simple flat yaml file with keys like your options. Env vars with a prefix and the same name as your options. All that is read and properly prioritized, keeping your docopt as the only source of truth for your app‚Äôs config.</p><p>It‚Äôs not for every tool (git would not be a good fit!) but for reasonably simple things it should be nice and easy.</p>","contentLength":696,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Annother Spinoff Shard: ralsina/rate_limiter","url":"https://forum.crystal-lang.org/t/annother-spinoff-shard-ralsina-rate-limiter/8525","date":1761949159,"author":"ralsina","guid":24,"unread":true,"content":"<p>I am sorry, I know I create a lot of topics all at once, but it happens when I actually have some time to work on my projects <img src=\"https://emoji.discourse-cdn.com/google_classic/smiley.png?v=15\" title=\":smiley:\" alt=\":smiley:\" loading=\"lazy\" width=\"20\" height=\"20\"></p><p>Basically, it‚Äôs a generic in-memory sliding window composible rate limiter. Usage looks like this:</p><pre data-code-wrap=\"crystal\"><code># Per user rate limiting\nuser_limiter = RateLimiter.new(50, 3600)  # 50 requests per hour per user\n\n# Per IP rate limiting\nip_limiter = RateLimiter.new(200, 3600)  # 200 requests per hour per IP\n\n# Per endpoint rate limiting\nendpoint_limiter = RateLimiter.new(20, 60)  # 20 requests per minute per endpoint\n\n# Per user + endpoint rate limiting\nuser_endpoint_limiter = RateLimiter.new(10, 60)  # 10 requests per minute per user+endpoint\n\n# Check request (example: user trying to access API)\nusername = \"alice\"\nip = \"10.0.0.1\"\nendpoint = \"/api/create_note\"\n\n# Check all applicable rate limits\nlimits = [\n  user_limiter.allow?(username),\n  ip_limiter.allow?(ip),\n  endpoint_limiter.allow?(endpoint),\n  user_endpoint_limiter.allow?(\"#{username}::#{endpoint}\")\n]\n\nif limits.any?\n  # Request is allowed by all rate limiters\n  process_request(username, ip, endpoint)\nelse\n  # Request exceeds at least one rate limit\n  render_error(\"Rate limit exceeded\")\nend\n</code></pre>","contentLength":1177,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Some performance testing","url":"https://forum.crystal-lang.org/t/some-performance-testing/8524","date":1761941070,"author":"ralsina","guid":23,"unread":true,"content":"<p>As I worked on <a href=\"https://tocry.ralsina.me\" rel=\"noopener nofollow ugc\">ToCry</a> I got curious about how well it performed.</p><p>It was  built with performance as the main goal. In fact it‚Äôs sort of guaranteed not to be the fastest way to do things. It uses <a href=\"https://github.com/ralsina/sepia\" rel=\"noopener nofollow ugc\">sepia</a> as data storage, which is the opposite of efficient, and I implemented it .</p><p>On the other hand, the best thing was to just write some scripts and measure things!</p><p>Turns out ‚Ä¶ it‚Äôs pretty fast? It can have about 20 simultaneous users and 300 RPS on a Pi 4 with 4GB of RAM, and industry standard says that equates to about 200 users.</p><p>200 users? On an old SBC!</p><p> This is not scientific. What a ‚Äúrealistic‚Äù load is needs to be discovered by having actual users :-)</p>","contentLength":661,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Second fiber does not complete","url":"https://forum.crystal-lang.org/t/second-fiber-does-not-complete/8523","date":1761929399,"author":"axd99","guid":22,"unread":true,"content":"<p>Hi, I am experimenting with crystal‚Äôs fibers and to test with a buffered channel I wrote this:</p><pre><code># generate a list of file names.\n# This is the data source.\nlist = [] of String\n(1..4).each do |i|\n  list &lt;&lt; \"file#{i}\"\nend\n\n# provides communication between the producing fiber and the\n# consuming one.\nch = Channel(String).new(3)\n\n# fiber1\n# this fiber loads the data into the channel\n# This is the producer.\nspawn do\n  puts \"--- Entering fiber1\"\n  list.each do |val|\n    puts \"fiber1, before send #{val}\"\n    ch.send val\n    puts \"fiber1, after send #{val}\"\n  end\n  puts \"--- Exiting fiber1\"\nend\n\n# fiber2\n# this fiber empties the channel\n# This is the consumer.\nspawn do\n  puts \"---- Entering fiber 2\"\n  while val2 = ch.receive\n    puts \"Received: #{val2}\"\n  end\n  puts \"---------------------\"   # The code does not get to here\n  puts \"---- Exiting fiber2\"\n  puts \"---------------------\"\nend\n\nputs \"Starting...\\n\"\n\n# Start the fibers\nFiber.yield\n\n# When the control gets back here all data has been exhausted.\nputs \"Goodbye!!!\"\n\n# shouldn't either of these 2 restart fiber2?\nFiber.yield\nch.close \np ch.closed?\n\n\n</code></pre><p>Now, when I run the above, all data is produced and consumed as expected.\nHowever the ‚Äò---- Exiting Fiber 2‚Äô never executed.</p><pre><code>$ crystal list-files.cr\nStarting...\n--- Entering fiber1\nfiber1, before send file1\nfiber1, after send file1\nfiber1, before send file2\nfiber1, after send file2\nfiber1, before send file3\nfiber1, after send file3\nfiber1, before send file4\n---- Entering fiber 2\nReceived: file1\nReceived: file2\nReceived: file3\nReceived: file4\nfiber1, after send file4\n--- Exiting fiber1\nGoodbye!!!\ntrue\n</code></pre><p>Any pointer would be most welcome.\nMany thanks.</p>","contentLength":1667,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Wanna do an MCP? Try this :-)","url":"https://forum.crystal-lang.org/t/wanna-do-an-mcp-try-this/8520","date":1761767213,"author":"ralsina","guid":21,"unread":true,"content":"<p><a href=\"https://modelcontextprotocol.io/docs/getting-started/intro\" rel=\"noopener nofollow ugc\">MCP</a> is a mechanism to expose things to AI agents.</p><p>Turns out it‚Äôs super easy to do, and it gives you some amazing leverage for tools! For example, I gave my <a href=\"https://tocry.ralsina.me\" rel=\"noopener nofollow ugc\">kanban board</a> a MCP server and now I can just say ‚Äúmove the note ‚Äúwhatever‚Äù to done‚Äù and it works ;-)</p><p>It supports stdio MCP servers (nice way to expose a CLI tool to AI agents) and web MCP servers (with kemal at least)</p><p>Here is a FULL example of a MCP with a single tool, in stdio mode:</p><pre data-code-wrap=\"crystal\"><code>require \"mcp\"\n\n# A simple tool that returns the answer to any question\nclass AnswerTool &lt; MCP::AbstractTool\n  @@tool_name = \"get_answer\"\n  @@tool_description = \"Returns 42 as the answer to any question you ask\"\n  @@tool_input_schema = {\n    \"type\"       =&gt; \"object\",\n    \"properties\" =&gt; {\n      \"question\" =&gt; {\n        \"type\"        =&gt; \"string\",\n        \"description\" =&gt; \"The question you want answered\",\n      },\n    },\n    \"required\" =&gt; [\"question\"],\n  }.to_json\n\n  def invoke(params : Hash(String, JSON::Any), env : HTTP::Server::Context? = nil)\n    question = params[\"question\"]?.try(&amp;.as_s) || \"unknown question\"\n    {\n      \"answer\"   =&gt; 42,\n      \"question\" =&gt; question,\n    }\n  end\nend\n\n# Start the stdio server - that's it! One line and you have a complete MCP server.\nMCP::StdioHandler.start_server\n</code></pre><p>Have fun and let me know if something is not ergnomic, I am trying to make this as boilerplate-free as possible.</p><p><small>14 posts - 6 participants</small></p>","contentLength":1393,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Airsailer - open source Cloud orchestrator in Crystal","url":"https://forum.crystal-lang.org/t/airsailer-open-source-cloud-orchestrator-in-crystal/8516","date":1761731144,"author":"paulocoghi","guid":20,"unread":true,"content":"<p>Missed you all during my cancer treatment, and I‚Äôm finally cancer-free!</p><p>I‚Äôm back full-time at my cloud computing startup, and going fully open source (MIT license) for the entire platform.</p><ul><li>LXC (Linux/system containers) for bare-metal performance, no VM overhead (PoC working)</li><li>elastic bare-metal hardware resources that can be changed without reboot</li><li>elastic LVM storage with thin-provisioning (manually handled today)</li><li>routing for local networks + WireGuard for clusters (manually handled today)</li><li><a href=\"https://blog.cloudflare.com/workerd-open-source-workers-runtime/#homogeneous-deployment\" rel=\"noopener nofollow ugc\">Homogeneous deployment</a> as the strategy for automatic horizontal scaling and load-balancing (will be on a future release with PaaS automation)</li><li>automatic proxy + SSL for apps, no need for 1 public IP per app (<a href=\"https://github.com/admiracloud/narnia\" rel=\"noopener nofollow ugc\">proxy lib</a> temporarily made in JS because of acme-client lib)</li></ul><p> IaaS+PaaS with 20% of features that cover 80% of cloud demand.</p><p>I‚Äôm refactoring and I will release soon at <a href=\"https://github.com/airsailer/airsailer\" rel=\"noopener nofollow ugc\">github.com/airsailer/airsailer</a>. Since I sustain my family only through this work, I expect to release a new production version soon.</p><p>Happy to talk to you again. <img src=\"https://emoji.discourse-cdn.com/google_classic/slightly_smiling_face.png?v=15\" title=\":slightly_smiling_face:\" alt=\":slightly_smiling_face:\" loading=\"lazy\" width=\"20\" height=\"20\"></p>","contentLength":1026,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Create parsor for simple if statements","url":"https://forum.crystal-lang.org/t/create-parsor-for-simple-if-statements/8514","date":1761585482,"author":"Fulgurance","guid":19,"unread":true,"content":"<p>Hi guys, I am seeking help/advice to make a very simple parser that use just  statement (I mean not with  statement or )</p><p>I did already a condition parser that work, but I don‚Äôt know how to manage if there is multiple if.</p><p>Basically, when my parser read a configuration file, I would like when it parse it to read the if statements:</p><pre data-code-wrap=\"crystal\"><code>if (condition)\n    if (condition)\n        (do this)\n    end\n    if (condition)\n        (do this)\n    end\nend\n</code></pre><p>How can I manage this ? I tried to put the problem on paper, find a way, but I actually don‚Äôt really find a solution. If someone have experience already with this, I will be grateful</p><p>In my example, if you are in the last condition, how can I know if I am not under the previous one ?</p>","contentLength":723,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Cml and choose - type problems","url":"https://forum.crystal-lang.org/t/cml-and-choose-type-problems/8509","date":1761466417,"author":"dsisnero","guid":18,"unread":true,"content":"<pre><code># =============================================================================\n# Concurrent ML `choose` type inference problem in Crystal\n# =============================================================================\n#\n# This document describes a real-world type inference limitation encountered\n# when porting John Reppy‚Äôs Concurrent ML (CML) design to Crystal language.\n#\n# The CML model centers on *events* (values of type `Event(T)`), which represent\n# potential synchronous communications or computations.  Multiple events can\n# be combined using `choose_evt` (nondeterministic choice), and only one branch\n# ‚Äúcommits‚Äù when synchronized via `sync(evt)`.\n#\n# The core invariant:  `choose` is purely a combinator; it doesn‚Äôt perform\n# until `sync` is called.  This design works well in SML because its type\n# inference engine easily unifies all branch result types, and events such as\n# `timeout_evt` or `never_evt` can safely coexist in a single choice.\n#\n# In Crystal, we‚Äôre very close ‚Äî but there‚Äôs a key *type inference barrier*:\n#\n# -----------------------------------------------------------------------------\n# Problem Summary\n# -----------------------------------------------------------------------------\n#\n# When combining heterogeneous `Event(T)` types in an `Array`, Crystal‚Äôs type\n# inference produces a union of the *concrete generic instantiations* rather\n# than a single polymorphic supertype.  This breaks overload resolution for a\n# method like:\n#\n#     def self.choose(evts : Array(Event(T))) : Event(T) forall T\n#\n# Example:\n#\n#     ch = CML::Chan(Int32).new\n#\n#     choice = CML.choose([\n#       CML.wrap(ch.recv_evt) { |_| :recv },              # Event(Symbol)\n#       CML.wrap(CML.timeout(0.1.seconds)) { |_| :timeout }, # Event(Symbol)\n#     ])\n#\n#     # ‚ùå Compiler error:\n#     # expected Array(Event(Symbol)), not Array(Event(Symbol) | TimeoutEvt)\n#\n# Even though all branches *conceptually* yield `Symbol`, Crystal‚Äôs invariance\n# and separate generic instantiations mean it cannot unify them automatically.\n#\n# In SML, this works because type inference is polymorphic by default:\n#    val e1 : ‚Äôa event\n#    val e2 : unit event\n#    val choice = choose [wrap e1 (fn _ =&gt; #recv), wrap timeout_event (fn _ =&gt; #timeout)]\n#\n# -----------------------------------------------------------------------------\n# Why `never` and `timeout` amplify the issue\n# -----------------------------------------------------------------------------\n#\n# - `never_evt` is typed as `Event(T)` but never produces a value ‚Äî it‚Äôs inert.\n#   In ML, this freely unifies with anything (like `‚Äôa event`).\n# - `timeout_evt` naturally yields a `Symbol` (`:timeout`) or unit.\n#   In practice, most real `choose` calls race real events against a timeout.\n#\n# In Crystal, these must share a single `T` type parameter in\n# `Array(Event(T))`, but the compiler cannot infer it when generics differ.\n#\n# -----------------------------------------------------------------------------\n# Workarounds tried\n# -----------------------------------------------------------------------------\n#\n# 1. Manual casting:\n#\n#        typed_never = CML.wrap(CML.never(Int32)) { |_| :never } as CML::Event(Symbol)\n#        choice = CML.choose([typed_never,\n#                             CML.wrap(ch.recv_evt) { |_| :recv },\n#                             CML.wrap(CML.timeout(0.1.seconds)) { |_| :timeout }])\n#\n#    ‚úÖ Works, but ugly and non-obvious for library users.\n#\n# 2. Force the array literal type explicitly:\n#\n#        choice = CML.choose([\n#          CML.wrap(CML.never(Int32)) { |_| :never },\n#          CML.wrap(ch.recv_evt) { |_| :recv },\n#          CML.wrap(CML.timeout(0.1.seconds)) { |_| :timeout },\n#        ] of CML::Event(Symbol))\n#\n#    ‚úÖ Works, but verbose and not ergonomic.\n#\n# 3. A dynamic fallback (library side):\n#\n#        def self.choose_any(evts : Array(Event) | Tuple)\n#          unified = evts.map do |e|\n#            CML.wrap(e.as(Event)) { |x| x.as(Symbol | Nil | Int32 | String) }\n#          end\n#          ChooseEvt(Symbol | Nil | Int32 | String).new(unified)\n#        end\n#\n#    ‚úÖ Works, allows mixing `TimeoutEvt` and others.\n#    ‚ö†Ô∏è Loses static type guarantees, since all results are widened into a big union.\n#\n# -----------------------------------------------------------------------------\n# Desired behavior\n# -----------------------------------------------------------------------------\n#\n# Ideally, Crystal could unify the type variable `T` across generic parameters\n# of `Event(T)` when placed in an array, producing something like:\n#\n#     Array(Event(Symbol))  ‚Üê rather than  Array(Event(Symbol) | TimeoutEvt)\n#\n# That would allow:\n#\n#     choice = CML.choose([\n#       CML.wrap(ch.recv_evt) { |_| :recv },\n#       CML.wrap(CML.timeout(0.1.seconds)) { |_| :timeout },\n#       CML.never(Int32)\n#     ])\n#     result = CML.sync(choice)\n#\n# to compile cleanly.\n#\n# -----------------------------------------------------------------------------\n# Minimal Repro\n# -----------------------------------------------------------------------------\n#\n# ```crystal\n# module CML\n#   abstract class Event(T); end\n#\n#   class TimeoutEvt &lt; Event(Symbol); end\n#   class RecvEvt(T) &lt; Event(T); end\n#\n#   def self.choose(evts : Array(Event(T))) : Event(T) forall T\n#     # no-op\n#     evts.first\n#   end\n# end\n#\n# ch = CML::RecvEvt(Int32).new\n# choice = CML.choose([ch, CML::TimeoutEvt.new])\n# ```\n#\n# ‚ùå Error: expected argument #1 to 'choose' to be Array(Event(Int32)), not Array(Event(Int32) | CML::TimeoutEvt)\n#\n# -----------------------------------------------------------------------------\n# Discussion questions for Crystal core / type system developers\n# -----------------------------------------------------------------------------\n#\n# 1. Could Crystal‚Äôs generic unification rules be relaxed to allow\n#    `Array(Event(Int32) | Event(Symbol))` to unify as `Array(Event(Int32 | Symbol))`\n#    when the same generic base type is used?\n#\n# 2. Is there a way for a library to express a ‚Äúvariance-like‚Äù constraint\n#    on generic parameters for this pattern ‚Äî e.g., `Event` being covariant in `T`?\n#\n# 3. Would a macro-level solution (`macro choose_evt(*evts)`) be able to\n#    introspect and compute a common union type of the block return values,\n#    producing an `Array(Event(common_union_type))` automatically?\n#\n# 4. Is there any pattern or compiler hint (`.splat`, `typeof(...)`) that can\n#    achieve this statically today without resorting to a huge union wrapper?\n#\n# -----------------------------------------------------------------------------\n# The goal\n# -----------------------------------------------------------------------------\n#\n# Bring Crystal‚Äôs ergonomics for typed event combinators closer to the\n# Concurrent ML model:\n#\n#     choose [timeout_evt, recv_evt, never_evt] |&gt; sync\n#\n# should ‚Äújust work‚Äù without any explicit type coercion,\n# while retaining static safety and type inference fidelity.\n#\n# -----------------------------------------------------------------------------\n# Thank you!\n# -----------------------------------------------------------------------------\n#\n# Any insight or future direction for generic covariance, inference improvements,\n# or macro-based workarounds would be incredibly valuable for Crystal libraries\n# that implement higher-level concurrency abstractions like Concurrent ML.\n#\n# -- Dominic Sisneros (dsisnero)\n# -----------------------------------------------------------------------------\n\n</code></pre>","contentLength":7505,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Equivalent of Ruby's `self.class::Subclass`","url":"https://forum.crystal-lang.org/t/equivalent-of-rubys-self-class-subclass/8508","date":1761426512,"author":"Cristian","guid":17,"unread":true,"content":"<p>I would like to convert this Ruby code to Crystal:</p><pre data-code-wrap=\"ruby\"><code># Ruby code\n\nclass P\n  class Sub\n    def m\n      \"from P::Sub\"\n    end\n  end\n  \n  def sub_m\n    self.class::Sub.new.m\n  end\nend\n\n\nclass C &lt; P\n  class Sub\n    def m\n      \"from C::Sub\"\n    end\n  end\nend\n\n\nputs C.new.sub_m # =&gt; \"from C::Sub\"\n\n</code></pre><p>By using ,  returns ‚Äúfrom C::Sub‚Äù instead of ‚Äúfrom P::Sub‚Äù, but this syntax is not valid in Crystal: <code>Error: unexpected token: \"::\"</code></p><p><small>17 posts - 7 participants</small></p>","contentLength":454,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"How can I force the type of a nested literal from the outside in?","url":"https://forum.crystal-lang.org/t/how-can-i-force-the-type-of-a-nested-literal-from-the-outside-in/8507","date":1761332308,"author":"Carlos","guid":16,"unread":true,"content":"<p>I want an array of , but</p><pre data-code-wrap=\"crystal\"><code>icr:1&gt; typeof([[\"str\"], [:sym], [\"str\", :sym]])\n =&gt; Array(Array(String | Symbol) | Array(String) | Array(Symbol))\n</code></pre><p>I can force the type of the inner arrays</p><pre data-code-wrap=\"crystal\"><code>icr:2&gt; typeof([[\"str\"] of String | Symbol, [:sym] of String | Symbol, [\"str\", :sym]])\n =&gt; Array(Array(String | Symbol))\n</code></pre><p>but I‚Äôd rather not do that, because that‚Äôs a lot of typing. I‚Äôd rather do</p><pre data-code-wrap=\"crystal\"><code>icr:3&gt; typeof([[\"str\"], [:sym], [\"str\", :sym]] of Array(String | Symbol))\nerror in line 1\nError: instantiating 'Pointer(Array(String | Symbol))#[]=(Int32, Array(String))'\n\n\nIn C:\\Users\\carlo\\scoop\\apps\\crystal\\current\\src\\pointer.cr:146:29\n\n 146 | (self + offset).value = value\n                               ^----\nError: type must be Array(String | Symbol), not Array(String)\n</code></pre><p>Shouldn‚Äôt the compiler propagate the type specification, not only from the inside out, but also from the outside in?</p>","contentLength":872,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Feasibility of multi-executable architecture for a large application using Crystal","url":"https://forum.crystal-lang.org/t/feasibility-of-multi-executable-architecture-for-a-large-application-using-crystal/8505","date":1761215553,"author":"gauravshah89","guid":15,"unread":true,"content":"<p>Crystal is my most-loved language <img src=\"https://emoji.discourse-cdn.com/google_classic/smiley.png?v=15\" title=\":smiley:\" alt=\":smiley:\" loading=\"lazy\" width=\"20\" height=\"20\"> and I have been using it for small personal projects on and off. I am now starting a new project that may not remain personal in the long-run and should eventually grow on to become a large and complex desktop app. Run time performance will be a key requirement for this application.</p><p>Since crystal has higher compile times compared to other languages, what is the best way to create very large and performant applications using crystal without getting bogged down by compile times?</p><p>My Strategy <img src=\"https://emoji.discourse-cdn.com/google_classic/smiling_face_with_sunglasses.png?v=15\" title=\":smiling_face_with_sunglasses:\" alt=\":smiling_face_with_sunglasses:\" loading=\"lazy\" width=\"20\" height=\"20\"> =&gt; Split the application into smaller  built from shared libraries rather than one monolithic Crystal binary. Rough proposed file structure given below:</p><p> will be a standalone Crystal app/lib  () that compile quickly and will be linked to each other.</p><ul><li>common/\n<ul><li>shard.yml         # shared library (types, utils)</li></ul></li><li>api/\n<ul><li>shard.yml         # depends on ../common</li></ul></li><li>worker/\n<ul><li>shard.yml         # depends on ../common</li></ul></li><li>cli/\n<ul><li>shard.yml         # minimal dependencies</li></ul></li></ul><p>Is this a scalable approach for developing and maintaining serious production applications in Crystal? If this does not work out, I will have to use Rust which I don‚Äôt prefer.</p><p>Thanks for reading this long question. <img src=\"https://emoji.discourse-cdn.com/google_classic/folded_hands.png?v=15\" title=\":folded_hands:\" alt=\":folded_hands:\" loading=\"lazy\" width=\"20\" height=\"20\"></p>","contentLength":1187,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Crystal 1.18.2 is released!","url":"https://forum.crystal-lang.org/t/crystal-1-18-2-is-released/8504","date":1761078055,"author":"Crys","guid":14,"unread":true,"content":"<p>We are announcing a new Crystal release 1.18.2 with two regressions fixed.</p>","contentLength":74,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"LSP implementation for Crystal on Windows","url":"https://forum.crystal-lang.org/t/lsp-implementation-for-crystal-on-windows/8502","date":1761048162,"author":"god","guid":13,"unread":true,"content":"<p>The tooling for Crystal on Windows is not good. I am working on a language server and VSCode extension that leverages the existing CLI tools available and incorporates them into an instant-response context so as to achieve features such as autocomplete, real-time error detection, etc‚Ä¶ on Windows, since Crystalline and Scry seem to be for POSIX platforms only.</p><p>Demo of its current capabilities can be observed <a href=\"https://streamable.com/2eh91i\" rel=\"noopener nofollow ugc\">here</a></p><p>Source code is <a href=\"https://github.com/navid-m/liger\" rel=\"noopener nofollow ugc\">here</a>, you can build the vsix for the vscode extension with ‚Äúnpm run package‚Äù, and the server itself with ‚Äúshards build‚Äù.</p>","contentLength":559,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Optimization for nillable var check and code","url":"https://forum.crystal-lang.org/t/optimization-for-nillable-var-check-and-code/8501","date":1761001042,"author":"AlexR","guid":12,"unread":true,"content":"<p>Is there something terser than this:</p><pre><code>getter tex : LibSDL::Texture*?\n\ndef render\n  tex = @tex\n  return unless tex\n  LibSDL.set_texture_alpha_mod(tex, 255)\n  ...\nend\n</code></pre><p>Original code, rejected by the compiler, being :</p><pre><code>getter tex : LibSDL::Texture*?\n\ndef render\n  LibSDL.set_texture_alpha_mod(@tex.as(LibSDL::texture*), 255) if @tex\n  ...\nend\n\n# compilation error\n# Error: can't cast (Pointer(LibSDL::Texture) | Nil) to Pointer(LibSDL::Texture)\n</code></pre>","contentLength":437,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Check if an array index exist","url":"https://forum.crystal-lang.org/t/check-if-an-array-index-exist/8500","date":1760905165,"author":"Fulgurance","guid":11,"unread":true,"content":"<p>Hi guys, I am actually coding a parser, and in my program I need to check if an index exist or not in the array. I did this, but when I try to run the code, crystal raise an error that my condition have  an index out of bound, why ?</p><pre data-code-wrap=\"crystal\"><code>elsif Parser::ElseFilter.matches?(strippedLine)\n    if !elsePresence[currentIfLevel-1].nil? &amp;&amp; elsePresence[currentIfLevel-1] || elsePresence[currentIfLevel-1].nil?\n        puts elsePresence.inspect\n        puts currentIfLevel-1\n        raise(\"Line #{index+1}\\nFile: #{path}\\nExtra else: #{line}\\nAn extra \\\"else\\\" was declared.\")\n    end\n</code></pre><p>Normally because I check if it is nil, I should not have problem with my condition no ?</p>","contentLength":658,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Ruby controversy - Crystal opportunity","url":"https://forum.crystal-lang.org/t/ruby-controversy-crystal-opportunity/8498","date":1760809266,"author":"dsisnero","guid":10,"unread":true,"content":"<p><a href=\"https://forum.crystal-lang.org/u/jgaskins\">@jgaskins</a> With the recent controversy happening in ruby over Ruby Central and also DHH, it might be an opportunity for the more followed Crystal enthusiasts to re-introduce Crystal to the ruby world.</p><p><small>10 posts - 6 participants</small></p>","contentLength":224,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Creating a compiler package for Tumbleweed‚Äôs main repository (and potentially bootstrapping the compiler)","url":"https://forum.crystal-lang.org/t/creating-a-compiler-package-for-tumbleweed-s-main-repository-and-potentially-bootstrapping-the-compiler/8497","date":1760803921,"author":"expeehaa","guid":9,"unread":true,"content":"<p>I have been using openSUSE Tumbleweed for a few years now and am maintaining a small number of packages for that distribution. A few months ago I went the (probably) common route from Ruby to Crystal and have been quite happy with it. I thought about getting a Crystal compiler package into Tumbleweed‚Äôs main repository, which would have the great benefit of enabling getting packages of other programs written in Crystal into the main repository as well, apart from making the compiler install process easier.\nI found the packages at <a href=\"https://build.opensuse.org/project/show/devel:languages:crystal\" rel=\"noopener nofollow ugc\">https://build.opensuse.org/project/show/devel:languages:crystal</a> but unfortunately they just extract a prebuilt binary, which, as far as I know, is not acceptable for Tumbleweed. Additionally, even though it is on the same build service and the name looks like it, it is not a devel project for Tumbleweed (which it would need to be to submit a package).</p><p>Effectively, this means the following:</p><ol><li>Each compiler version package must be built from source.</li><li>Either <a href=\"https://build.opensuse.org/project/show/devel:languages:crystal\" rel=\"noopener nofollow ugc\">devel:languages:crystal</a> needs to become a devel project for Tumbleweed, or a new project needs to be created. (The naming conflict would need to be solved, potentially together with the Tumbleweed maintainers.)</li></ol><p>The first point is especially interesting because, if I understand correctly, up until 1.0, each compiler version needs the previous version to compile. I see 2 solutions for this problem:</p><ul><li>Bootstrap a recent compiler from the old Ruby implementation.\n</li><li>Use a prebuilt binary to compile a recent compiler in the package build process, and base packages for the following versions on that.</li></ul><p>How this has to be handled depends on the Tumbleweed maintainers. Unfortunately, I haven‚Äôt received an answer through the appropriate Matrix and Discord channels, so I guess I have to try the mailing list next.</p><p>For the second point, as per <a href=\"https://en.opensuse.org/openSUSE:How_to_contribute_to_Factory#How_to_request_a_new_devel_project\" rel=\"noopener nofollow ugc\">the openSUSE Wiki</a>, it may be as easy as writing an email to a specific mailing list. One requirement is that the  group would become a maintainer of the project. (I don‚Äôt see this as an issue, just wanted to point it out in case someone else does.)</p><p>I am not sure how both points would affect the package builds for other distributions. DPKG-based distributions could be completely unaffected, but RPM-based ones seem tricky. Their packages could also be built from source, but if that is not realistically possible for even a single one, the source-compiling Tumbleweed packages may need to be separate.\nIf it needs to be separate, I think a new subproject <code>devel:languages:crystal:Factory</code> would be most fitting, to not bother users of the existing project.</p><p>I would be willing and (probably) able to do most if not all of the packaging work (apart from what I have no permissions for). With this post I want to get the thoughts of you Crystal compiler people on that topic in general, and specifically for the following questions:</p><ol><li>What do you think about having the Crystal compiler in Tumbleweed‚Äôs main repository?</li><li>Is there a preference for changing existing package build instructions vs. having a new subproject specifically for Tumbleweed (with the option of building for openSUSE Leap as well)?</li><li>If the compiler needs to be bootstrapped, would someone be able to support me a bit in debugging? (Outside of this thread, of course.)</li></ol>","contentLength":3258,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Crystal 1.18.1 is released!","url":"https://forum.crystal-lang.org/t/crystal-1-18-1-is-released/8495","date":1760727237,"author":"Crys","guid":8,"unread":true,"content":"<p>We are announcing a new Crystal release 1.18.1 with two regressions fixed.</p>","contentLength":74,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Reactions on issues and PRs","url":"https://forum.crystal-lang.org/t/reactions-on-issues-and-prs/8490","date":1760646689,"author":"straight-shoota","guid":7,"unread":true,"content":"<p>Reactions on issues and PRs are helpful to gauge their importance.</p><p>For example, the <a href=\"https://github.com/crystal-lang/crystal/issues?q=%20is%3Aissue%20is%3Aopen%20sort%3Areactions-%2B1-desc\">list of issues sorted by <img src=\"https://emoji.discourse-cdn.com/google_classic/+1.png?v=14\" title=\":+1:\" alt=\":+1:\" loading=\"lazy\" width=\"20\" height=\"20\"> reactions</a> shows which issues people find relevant.\nWhile that‚Äôs not the only metric to determine acceptance and prioritization of a change, it can help move important stuff further ahead.</p><p>On the nix repository, I found this little detail: All PRs have a footer that encourages people to leave a reaction to show their interest in the topic.</p><p>It‚Äôs not super important. Reactions work just fine without this encouragement.\nBut it‚Äôs less organized and can be messy considering there are a number of different reactions with different meanings.</p><p>Maybe such a note could be useful. It reminds readers about leaving a reaction. And it points out the <img src=\"https://emoji.discourse-cdn.com/google_classic/+1.png?v=14\" title=\":+1:\" alt=\":+1:\" loading=\"lazy\" width=\"20\" height=\"20\"> reaction as a single metric.</p>","contentLength":783,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Incremental static typechecking","url":"https://forum.crystal-lang.org/t/incremental-static-typechecking/8485","date":1760607228,"author":"boulme","guid":6,"unread":true,"content":"<p>I am quite a newbie to Crystal. On many aspects, I find that its design is very smart. But one thing really hurts me: its type-checking is not compositional. Let me detail this on the following example:</p><pre data-code-wrap=\"crystal\"><code>def demo(c : Class) : Nil\n  a = c.new()\n  puts(\"demo on #{a.class}\")\n  (1..10).each {|x| a.push(x*x)}\n  puts(a)\nend\n\ndemo(Array(Int32))\ndemo(Array(Float64))\n</code></pre><p>This program is well-typed. But, if we add the following line, it becomes ill-typed.</p><p>And the type-checker declares an issue in the definition of  and not on the call with the issue.</p><blockquote><p>4 | (1..10).each {|x| a.push(x*x)}\n^ to ‚ÄòArray(Bool)‚Äô to be Bool, not Int32</p></blockquote><p>In all other strongly-type language that I know, type interfaces of methods/functions are contracts: their validity is checked on function definitions - and only the type interface is used for typing function calls : this makes type-checking compositional.</p><p>This is not the case for Crystal. Type restrictions are not contract: they only restrict call contexts (and they are used as guards for multiple dispatch).</p><p>Having a non-compositional type checking has huge consequences: this makes debugging harder, this makes incremental compilation impossible, which has itself other consequences, such as very slow compilation times, and poor interactions with LSP-server.</p><p>It seems difficult to make Crystal type-checking compositional without loosing too much expressiveness. For example, on the above example we would need to make  a generic method over a type , such that  and . Including such constraints in the language and its type-checking seems really challenging. Such complex constraints might not be inferred and should be instead provided by programmers.</p><p>Moreover, backward compatibility would be broken (which can be mitigated with a flag on the compiler). But, the benefits may worth the price of these difficulties ?</p><p><small>14 posts - 6 participants</small></p>","contentLength":1863,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null}],"tags":["community"]}