{"id":"Pufd3b1W2k6wTiLsAaYmfbmYhpt2oECwmzhkA1Gmy5385NLty9yVj866","title":"Crystal Forum - Latest topics","displayTitle":"Forum","url":"https://forum.crystal-lang.org/latest.rss","feedLink":"https://forum.crystal-lang.org/latest","isQuery":false,"isEmpty":false,"isHidden":false,"itemCount":30,"items":[{"title":"Memory usage of HTTP one-shot vs maintaining a persistent connection","url":"https://forum.crystal-lang.org/t/memory-usage-of-http-one-shot-vs-maintaining-a-persistent-connection/8237","date":1752609485,"author":"jgaskins","guid":49,"unread":true,"content":"<p>I deployed <a href=\"https://zomglol.wtf/@joco_ks_weather\" rel=\"noopener nofollow ugc\">a Mastodon bot</a> a couple weeks ago that polls a US National Weather Service RSS feed for an airport in my county and posts to Mastodon when it updates. I was using the  “one-shot” methods that spin up an HTTP connection, send the request, then terminate the connection.</p><p>I expected this bot to use very little RAM (less than 10MB) because it’s  very little:</p><ol><li>Makes an HTTP request to get the RSS feed</li><li>Iterates over each feed item (there’s only one)</li><li>If it hasn’t been posted yet (tracked by a key in Redis or a record in SQLite), make an HTTP request to the Mastodon API</li></ol><p>What surprised me was that RAM consumption grew over time.</p><p>The first two lines show linear memory growth. I restarted the app and it happened again. Then I tried a few more experiments:</p><ul><li>Replace SQLite with Redis</li><li>Replace the RSS feed parser with using stdlib  directly</li><li>Remove all XML parsing and just use regexes (yes, <a href=\"https://stackoverflow.com/a/1732454\" rel=\"noopener nofollow ugc\">I know</a>, don’t worry about it)</li><li>Compile the app using  for the specific aarch64 CPUs I’m using on GCP</li><li>Cap memory usage to 20MB so it’ll just restart when it exceeds it</li><li>Use a persistent HTTP connection</li></ul><p>The first 4 didn’t do anything useful. Capping memory usage actually caused an additional problem — it caused the app to crash  persisting that it was posting to Mastodon but  actually posting.</p><p>The punchline is in the image above, but after almost 24 hours using a persistent HTTP connection (<a href=\"https://github.com/jgaskins/http_client\" rel=\"noopener nofollow ugc\">with a connection pool</a>) for both the RSS feed and the Mastodon API, memory usage has tapered at about 5MB. This is the only thing that kept RAM stable at single-digit MB.</p><p>That makes me wonder if there’s something in OpenSSL (either in the version of OpenSSL itself that’s included in <a href=\"https://github.com/toddsundsted/ktistec\" rel=\"noopener nofollow ugc\">the 84codes Alpine-based container images</a> or in the Crystal bindings for it) that’s causing it to leak memory. I’ve only ever seen this kind of memory growth in <a href=\"https://github.com/toddsundsted/ktistec\" rel=\"noopener nofollow ugc\">Ktistec</a>, which is why I thought it might be something in SQLite but it happening when running one-shot HTTP requests would also track.</p><p>Regardless of the reason, if you want to minimize memory consumption in an app that talks to other HTTP services, reusing HTTP connections will do that.</p>","contentLength":2132,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"OpenSSL::Digest store and resume","url":"https://forum.crystal-lang.org/t/openssl-digest-store-and-resume/8236","date":1752597712,"author":"dup2","guid":48,"unread":true,"content":"<p>I’m trying to implement a “resumable” SHA256 digest which can be persisted and later resumed when new data arrives, the use case is a distributed uploader where the data arrives in chunks.</p><p>For this, I’m trying to store a LibCrypto::EVP_MD_CTX_Struct somewhere (disk, redis) and then later resuming with a new Digest::SHA256 instance (or an extension of it as the initializer with a ctx is protected).</p><p>Any pointers for this? Is this even possible? (I failed so far..)</p>","contentLength":472,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Bind macro for use in web dev","url":"https://forum.crystal-lang.org/t/bind-macro-for-use-in-web-dev/8229","date":1752493677,"author":"u89012","guid":47,"unread":true,"content":"<p>I’ve the following macros (which works fine) which I’d like to enhance so it can be used to bind to form args as well – I’ve tried a bunch of variations but can’t seem to get it right, LLMs haven’t been helpful either (as they seem to produce code that iterates over the  which refuses to compile), can someone please help?</p><pre><code>macro bind(type)\n  {{type}}.from_json(context.request.body.not_nil!)\nend\n\nmacro bind(**args)\n  NamedTuple({{args.double_splat}}).from_json(context.request.body.not_nil!)\nend\n</code></pre><p>Which can be used like so:</p><pre><code>alias User = NamedTuple(email: String, password: String, remember_me: Bool?)\n#...\npayload = bind(User) #works fine for predefined types\n\n# using the second version with **args\npayload = bind(email: String, password: String, remember_me: Bool?) #works fine for one off captures too\n</code></pre><p>Assuming  exists (which merges ,  and ) how would one go about extending the above two macros so it handles both JSON and form params? I understand binding to form params can be tricky for nested structures but I’m hoping to get to a bare minimum version that can be useful.</p>","contentLength":1092,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"High level LLM libraries?","url":"https://forum.crystal-lang.org/t/high-level-llm-libraries/8221","date":1752230594,"author":"Brunette69","guid":46,"unread":true,"content":"<p>I am working on a local RAG system.\nAre there any bindings or libraries to work with smaller LLM’s directly on CPU at least. For embedding text, comparing (rerank) and summarization/gen.</p><p>I tried many things.\nOllama rest api, no rerank, built upon llama.cpp.<p>\nTried llama.cpp llama-server, embeding/pooling doesn’t work.</p>\nTried openvino, hit a wall with pipeline setup. Needs python scripts etc.<p>\nTried onnx, some onnx attempt by kojix also on crystal. But again I hit a wall again at tokenizing.</p>\nAs I see tokenizer support is crucial.</p><p>Now soome very low level libraries for ML seem to be available, but\nare there any higher level libraries available in crystal?</p><p>Features:\nLoading/unloading a model, send text to embed, get 1 embeded vector (mean, last, cls..), rerank and generate.<p>\nEither as bindings to C/C++ or as a separate REST API fast small http server.</p></p><p>Any info, directions, experience of yours (especially positive) would be very welcome.\nThank you in advance.</p>","contentLength":965,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"For 2.0: Make Default Values i64 vs i32","url":"https://forum.crystal-lang.org/t/for-2-0-make-default-values-i64-vs-i32/8216","date":1752082751,"author":"jzakiya","guid":45,"unread":true,"content":"<p>It’s been about 2 decades since 64-bit systems became the dominant platform for general computing systems. Additionally, default system memory has risen from 1-2 GB to 16-32GB, with many systems providing available memory of 128GB.</p><p>Currently, if you do:   its explicit definition is .\nI propose making values default to , thus  defaults to be .</p><p>\nI primarily do numerical applications. I sometimes run into runtime arithmetic overflows because somewhere in the code is an implicit  value I have to track down and change to an  while doing a series of arithmetic operations.  This will possibly make the use of  values easier to see and use in code.</p><p>This should also apply to  for , , and  , to provide better access to memory beyond  lengths|addresses.</p><p>Again, since most hardware is  oriented, it’s actually more efficient|faster to use the native size structure of the hardware as much as possible to optimize compiler efficiency and output.</p><p>Other languages have already (at least in part) made  values|operations their default configurations to take better advantage of hardware.</p><p>\nSince 2.0, by default, will introduce breaking changes, this should not be too distruptive.  Old code should work with no|little change, as values &lt;  would operate as before.  Now, to limit sizes of values &lt;   would require explicit type declarations, as currently necessary for values &lt; and &gt; .</p>","contentLength":1375,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Get enum underlying type in compile time","url":"https://forum.crystal-lang.org/t/get-enum-underlying-type-in-compile-time/8215","date":1752062962,"author":"mentalblood","guid":44,"unread":true,"content":"<p>Is it possible to get enum underlying type in compile type (i.e. in macro)? Stuck with this trying to support enum types in storage schema providing correct storage type like UInt8/UInt16 so to reduce storage usage but also support large enums if needed</p>","contentLength":253,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Sqlite3_compress: Custom compression functions in crystal-sqlite3","url":"https://forum.crystal-lang.org/t/sqlite3-compress-custom-compression-functions-in-crystal-sqlite3/8213","date":1752038295,"author":"plambert","guid":43,"unread":true,"content":"<p>I’ve also just released sqlite3_compress, which implements gzip, deflate, and zlib compression in SQLite user defined functions.</p><p>It might serve as an example of how to implement custom functions. Or it might serve as an example of how  to do it… let me know what you think, either way!</p><p>For example: <code>db.exec \"INSERT INTO my_table (url, html_gzip) VALUES (?, COMPRESS_GZIP(?))\", url, html</code></p>","contentLength":388,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Sqlite3_uri: Support URI objects in sqlite3 bindings","url":"https://forum.crystal-lang.org/t/sqlite3-uri-support-uri-objects-in-sqlite3-bindings/8212","date":1752012068,"author":"plambert","guid":42,"unread":true,"content":"<p>I might make a pull request to add it to crystal-sqlite3; however, if I do, it’d be a separate  as I think such things need to be conscious decisions by the programmer, and because folks might already have their own implementations.</p><p>Regardless, hopefully it also serves as an example of how to do this for any class or struct.</p><p>Comments, issues, pull requests, and cash donations are welcome!</p>","contentLength":391,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"SHAInet v3.0.1 Released!","url":"https://forum.crystal-lang.org/t/shainet-v3-0-1-released/8209","date":1751999147,"author":"bararchy","guid":41,"unread":true,"content":"<p>It has been quite a while since a release of <a href=\"https://github.com/NeuraLegion/shainet\" rel=\"noopener nofollow ugc\">SHAInet</a> happened.</p><p>\nSHAInet is a full neural network and deep learning framework made in pure crystal, it can train actual LLMs and can use CUDA for fast operations.</p><p>The latest changes bring forth:</p><ol><li>GPU support for CUDA and CUDBLAS</li><li>LLM network support with an example training on the BabyLM Challagne.</li><li>Support for GPT2\\GPT3 features.</li><li>Transformer layers with sinusoidal positional encoding</li><li>BPE tokenizer and vocabulary training</li><li>Cross-entropy loss for language modeling</li><li>CUDA acceleration (with cuDNN)</li><li>Streaming datasets in JSONL</li><li>Autograd, AdamW optimizer</li><li>GPU-friendly mini-batch training</li></ol><p>\nIf you want to understand neural network more deeply but don’t want to use python or getting into huge eco-systems like PyTorch or TensorFlow.<p>\nMaybe you want to train a small model at home? or maybe you want to run some model from hugging face and run it inside crystal code?</p></p><p><strong>Why are you wasting your time on this project for the last 8 years?</strong>\nI hold a dream about Crystal being a mainstream language or at least a more popular one, SHAInet was aimed at bringing easy to use real world deep learning into the world of Crystal, and now that the new tech moved from computer vision and simple networks into the realm of LLMs I thought that it wasn’t fair to keep us without a library that can work in that regard.<p>\nAlso, I just love Crystal what can I say ;)</p></p>","contentLength":1375,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Crystal Compass","url":"https://forum.crystal-lang.org/t/crystal-compass/8208","date":1751987349,"author":"Crys","guid":40,"unread":true,"content":"<p><a href=\"https://manas.tech/\">Manas.Tech</a>, the company behind Crystal, launches a new service: .</p>","contentLength":65,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Yes, another project: KV, a remote KVM solution","url":"https://forum.crystal-lang.org/t/yes-another-project-kv-a-remote-kvm-solution/8207","date":1751896169,"author":"ralsina","guid":39,"unread":true,"content":"<p>I know, I know, I start too many things, but this one is nice!</p><p>What is KV? A remote KVM.</p><p>If you are familiar with <a href=\"https://pikvm.org/\" rel=\"noopener nofollow ugc\">PiKVM</a><a href=\"https://jetkvm.com/\" rel=\"noopener nofollow ugc\">JetKVM</a> or other similar things, they are gadgets that connect to a server and basically put them in the matrix:</p><ul><li>They capture the HDMI output</li><li>They provide keyboard and mouse and mass storage via USB</li></ul><p>And then … they create a webpage where you can see the video and send keyboard and mouse input to the server. This is different from VNC or RDP in that it’s all hardware to the server, so you can remotely access the server BIOS or even install the OS to it.</p><p>I got frustrated trying to figure out why no existing solution could run with my perfectly nice hardware I had in a drawer (a Radxa zero, some cables and a $5 USB dongle to capture video), so I sat down for a day and wrote it <img src=\"https://emoji.discourse-cdn.com/google_classic/slight_smile.png?v=14\" title=\":slight_smile:\" alt=\":slight_smile:\" loading=\"lazy\" width=\"20\" height=\"20\"> this would not have been possible without Crystal, so thanks folks!</p>","contentLength":867,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Process: keep the colored output","url":"https://forum.crystal-lang.org/t/process-keep-the-colored-output/8203","date":1751652639,"author":"Fulgurance","guid":38,"unread":true,"content":"<p>Hi guys, I have a question. When I use Process.run, can it be possible to keep the command output color ?</p><p>For example, if I run this, the ouput is only black and white. But normally ls have a colored output:</p><pre data-code-wrap=\"crystal\"><code>Process.run(\"ls\", shell: true, output: Process::Redirect::Inherit)\n</code></pre>","contentLength":273,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Compiling Crystal from Github Master Branch - PKGBUILD x86_64/arm64v8/aarch64","url":"https://forum.crystal-lang.org/t/compiling-crystal-from-github-master-branch-pkgbuild-x86-64-arm64v8-aarch64/8202","date":1751652136,"author":"Ferguson","guid":37,"unread":true,"content":"<p>After some time I get the PKGBUILD to compile to Arch Linux(arm64v8-aarch64) from master branch:</p><pre><code>pkgname=crystal-git-master\npkgver=1.17.0\npkgrel=1\npkgdesc=\"The Crystal Programming Language\"\narch=('x86_64' 'aarch64')\nurl=\"http://crystal-lang.org\"\nlicense=('Apache')\ndepends=('gc' 'pcre2' 'libevent')\nmakedepends=('git' 'libxml2' 'llvm' 'crystal')\ncheckdepends=('libyaml' 'libxml2' 'gmp' 'git' 'inetutils')\noptdepends=('shards: To make the crystal deps command work'\n            'libyaml: For YAML support'\n            'gmp: For BigInt support'\n            'libxml2: For XML support')\nconflicts=('crystal')\nprovides=('crystal')\nsource=(\"git+https://github.com/crystal-lang/crystal.git#branch=master\")\n\nprepare() {\n  cd \"$srcdir/${pkgname/-git/}\"\n\n  if [ \"$CARCH\" = \"aarch64\" ]; then\n    export EXPORT_CC=\"CC=cc\" # prevent lld usage, broken on  aarch64\n  fi\n}\n\nbuild() {\n  cd \"$srcdir/${pkgname/-git/}\"\n\n  make release=1 FLAGS=\"--no-debug\" \\\n       CRYSTAL_PATH=\"$srcdir/${pkgname/-git/}/src:$srcdir/${pkgname/-git}/lib\" \\\n       CRYSTAL_CACHE_DIR=\"/tmp/crystal\"\n  make docs CRYSTAL_CACHE_DIR=\"/tmp/crystal\"\n}\n\ncheck() {\n  cd \"$srcdir/${pkgname/-git/}\"\n\n  make -j1 compiler_spec std_spec \\\n       CRYSTAL_PATH=\"$srcdir/${pkgname/-git/}/src:$srcdir/${pkgname/-git}/lib\" \\\n       CRYSTAL_CONFIG_VERSION=\"$pkgver\" \\\n       CRYSTAL_CACHE_DIR=\"/tmp/crystal\"\n}\n\npackage() {\n  cd \"$srcdir/${pkgname/-git/}\"\n\n  make install install_docs PREFIX=\"$pkgdir/usr\"\n  install -Dm644 src/llvm/ext/llvm_ext.o \"$pkgdir/usr/share/crystal/src/llvm/ext/llvm_ext.o\"\n  cp -av lib/ \"$pkgdir/usr/share/crystal/lib/\"\n}\n\nsha256sums=('SKIP')\n</code></pre><p>I tested that on Orange PI 5 Max with BredOS(arm64v8):</p><pre><code>crystal-git/src/crystal$ bin/crystal -v\nUsing compiled compiler at .build/crystal\nCrystal 1.17.0-dev [f8877f850c] (2025-07-04)\n\nLLVM: 20.1.7\nDefault target: aarch64-unknown-linux-gnu\n\n</code></pre><p>Some features is not enabled as interactive interface.</p>","contentLength":1901,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Issue with having to compile all shards when compile the application","url":"https://forum.crystal-lang.org/t/issue-with-having-to-compile-all-shards-when-compile-the-application/8201","date":1751620733,"author":"Haddock","guid":36,"unread":true,"content":"<p>I happened to read this article:</p><p>“Incremental compilation for Crystal - Part 3”</p><p>This is an interesting problem. Scala (some alternative language for the JVM) also heavily relies on type inference. Types in signatures of public methods in Scala may also not have types declared, but there is no problem in Scala that Scala libraries that are imported also need to be compiled. But Scala is different as being a JVM language that uses a VM that interpretes intermediate byte code (and creates machine code on the fly). Secondly, Java aka the JVM is build on type erasure, that is the type information is thrown away once the intermediate byte code was genereated by the Java or Scala compiler that is interpreted by the VM.</p><p>Maybe one solution would be also to have some intermediate code and binding it to the hardware is only done on the first invocation when starting up everything. This is also what the Microsoft languages do (Visual Basic, C#, F#). But I’m a “normal” application developer with little knowledge about compiler construction. Just my 5 cents. Would be so nice this problem in Crystal could be solved.</p>","contentLength":1125,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Kagi Search is Hiring","url":"https://forum.crystal-lang.org/t/kagi-search-is-hiring/8194","date":1751412990,"author":"nobodywasishere","guid":35,"unread":true,"content":"<p>Description As a member of the Backend team, you will be a graceful conductor of all the data flowing through the Kagi system. We are the beating drum that keeps everything running like clockwork a...</p>","contentLength":200,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Question about running stripping process","url":"https://forum.crystal-lang.org/t/question-about-running-stripping-process/8193","date":1751384400,"author":"Fulgurance","guid":34,"unread":true,"content":"<p>Hi guys, I am actually trying to fin a good way to strip a file list.</p><p>I tried into a process, but the problem is if one stripping fail (for example because it’s a Dir), it stop the stripping. Have you got any suggestion to  bypass this ? You need to keep in mind that I need performance, and I can’t pay the cost to use a process for every single file.</p><p>My software handle the use of the bit SUID if you wonder.</p><p>Actually my program is using this method, but most of the file are not stripped.</p><pre data-code-wrap=\"crystal\"><code>def stripFileListNoChroot(fileList : Array(String))\n\n            requestedCommands = &lt;&lt;-CMD\n            strip --strip-unneeded #{fileList.join(\"\\\" || true\\nstrip --strip-unneeded \\\"\")} || true\n            CMD\n\n            process = Process.run(requestedCommands, shell: true)\n\n            rescue\nend\n</code></pre>","contentLength":792,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Help on a Google OAuth login working example? (I tried with multi_auth, it work with Github, but not with Google)","url":"https://forum.crystal-lang.org/t/help-on-a-google-oauth-login-working-example-i-tried-with-multi-auth-it-work-with-github-but-not-with-google/8192","date":1751359895,"author":"zw963","guid":33,"unread":true,"content":"<p>Hi, Can anyone help on give me a Google OAuth2 login working example? only email address is required.</p><p>I tried with <a href=\"https://github.com/msa7/multi_auth\" rel=\"noopener nofollow ugc\">multi_auth</a> shard, but failed with a message:</p><p>The caller does not have permission to request “people/me”. Request requires one of the following scopes: [profile].</p><pre><code> GET /multi_auth/google/callback?code=4%2F0AVMBsJjvssA-eqjJQ-8EXtIeOy23ZmYMe4Iid9q4loqw7L1JL8KHVnHZn_Q-yTxEYxwpXQ&amp;scope=email+openid+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email&amp;authuser=0&amp;prompt=none\n  ▸  MultiAuth::Exception\n      The caller does not have permission to request \"people/me\". Request requires one of the following scopes: [profile].\n     Backtrace\n      lib/multi_auth/src/multi_auth/providers/google.cr:87:15 in 'build_user'\n      lib/multi_auth/src/multi_auth/providers/google.cr:59:5 in 'user'\n      lib/multi_auth/src/multi_auth/engine.cr:30:5 in 'user'\n      /src/actions/sign_ups/oauth/callback.cr:4:3 in 'action_call_body'\n      /src/actions/sign_ups/oauth/callback.cr:4:3 in 'call'\n      lib/lucky/src/lucky/renderable.cr:130:16 in 'perform_action'\n      lib/lucky/src/lucky/route_handler.cr:10:7 in 'call'\n      Crystal/share/crystal/src/http/server/handler.cr:30:7 in 'call_next'\n      lib/lucky/src/lucky/remote_ip_handler.cr:26:5 in 'call'\n      Crystal/share/crystal/src/http/server/handler.cr:30:7 in 'call_next'\n      lib/lucky/src/lucky/error_handler.cr:15:5 in 'call'\n      Crystal/share/crystal/src/http/server/handler.cr:30:7 in 'call_next'\n      lib/lucky/src/lucky/log_handler.cr:34:9 in 'call'\n      Crystal/share/crystal/src/http/server/handler.cr:30:7 in 'call_next'\n      lib/lucky/src/lucky/http_method_override_handler.cr:11:5 in 'call'\n      Crystal/share/crystal/src/http/server/handler.cr:30:7 in 'call_next'\n      lib/lucky/src/lucky/force_ssl_handler.cr:37:7 in 'call'\n      Crystal/share/crystal/src/http/server/handler.cr:30:7 in 'call_next'\n      lib/lucky/src/lucky/request_id_handler.cr:24:5 in 'call'\n      Crystal/share/crystal/src/http/server/request_processor.cr:51:11 in 'process'\n      Crystal/share/crystal/src/http/server.cr:521:5 in 'handle_client'\n      Crystal/share/crystal/src/http/server.cr:451:5 in '-&gt;'\n      Crystal/share/crystal/src/fiber.cr:170:11 in 'run'\n      Crystal/share/crystal/src/fiber.cr:105:3 in '-&gt;'\n</code></pre><p>I create a issue <a href=\"https://github.com/msa7/multi_auth/issues/46\" rel=\"noopener nofollow ugc\">there</a> too.</p>","contentLength":2304,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"How do you get the location name of the local timezone?","url":"https://forum.crystal-lang.org/t/how-do-you-get-the-location-name-of-the-local-timezone/8191","date":1751345040,"author":"syeopite","guid":32,"unread":true,"content":"<p>For some reason I can only get  as the output rather than something like  within Crystal.</p><pre data-code-wrap=\"crystal\"><code>Time::Location.local.name # =&gt; \"Local\"\nTime.local.location.name # =&gt; \"Local\"\nTime.local.to_s(\"%Z\") # =&gt; \"Local\"\n</code></pre>","contentLength":201,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"High memory usage copying data from a `HTTP::FormData::Part` into a `IO::Memory`","url":"https://forum.crystal-lang.org/t/high-memory-usage-copying-data-from-a-http-part-into-a-io-memory/8190","date":1751317848,"author":"Fijxu","guid":31,"unread":true,"content":"<p>Hi, I have been scratching my head when it comes with this piece of code:</p><pre><code>require \"http\"\n\nserver = HTTP::Server.new do |context|\n  name = nil\n  file = nil\n\n  HTTP::FormData.parse(context.request) do |part|\n    io = IO::Memory.new\n    if body = part.body\n      IO.copy(body, io)\n    end\n\n    file = File.tempfile(\"upload\") do |file|\n      IO.copy(io, file)\n    end\n  end\n  if file\n    context.response &lt;&lt; file.path\n  end\nend\n\nserver.bind_tcp 8085\nserver.listen\n</code></pre><p>The problem is that when the  from the part is copied into the , the memory usage increases by the double the size of the file being uploaded on the form, so if I upload a 25MB file using <code>curl -F \"file=@/home/user/somefile.mp4\" http://localhost:8085/</code>, the memory usage increases up to ~50MB (double the file size).</p><p>The exact same thing happens when I do:</p><pre><code>  HTTP::FormData.parse(context.request) do |part|\n    part.body.getb_to_end\n    file = File.tempfile(\"upload\") do |file|\n      IO.copy(part.body, file)\n    end\n  end\n</code></pre><p>However, when I use this instead:</p><pre><code>HTTP::FormData.parse(context.request) do |part|\n    file = File.tempfile(\"upload\") do |file|\n      IO.copy(part.body, file)\n    end\n  end\n</code></pre><p>It uses 0 additional memory.</p><p>I would like to understand why Crystal uses double the memory when using:</p><pre><code>io = IO::Memory.new\nif body = part.body\n  IO.copy(body, io)\nend\n</code></pre>","contentLength":1314,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Sepia: a object-hierarchy-to-disk serializer shard","url":"https://forum.crystal-lang.org/t/sepia-a-object-hierarchy-to-disk-serializer-shard/8187","date":1750993624,"author":"ralsina","guid":30,"unread":true,"content":"<p>I have not seen this around but it’s a pattern I use a lot in my own coding:</p><ul><li>I want data structured in a hierarchy</li><li>I want to save it to disk</li><li>I don’t want to use a database, I want to use plain old files and directories</li></ul><ul><li>Because I don’t want to lock the user in.</li><li>Because I want to manipulate the data using unixy tools</li><li>Because I want to version-control it</li></ul><p>So, that’s Sepia. You lightly annotate your classes, and write how they can be turned to/from a string.  Then you can roundtrip from/to your data tree to a directory tree.</p><pre data-code-wrap=\"crystal\"><code>require \"sepia\"\n\n# Configure Sepia to use a local directory for storage.\nSepia::Storage::INSTANCE.path = \"./_data\"\n\n# A Postit is a simple Serializable object.\nclass Postit\n  include Sepia::Serializable\n\n  property text : String\n\n  def initialize(@text); end\n  def initialize; @text = \"\"; end\n\n  # The to_sepia method defines the content of the serialized file.\n  def to_sepia : String\n    @text\n  end\n\n  # The from_sepia class method defines how to deserialize the object.\n  def self.from_sepia(sepia_string : String) : self\n    new(sepia_string)\n  end\nend\n\n# A Board is a Container that can hold other Boards and Postits.\nclass Board\n  include Sepia::Container\n\n  property boards : Array(Board)\n  property postits : Array(Postit)\n\n  def initialize(@boards = [] of Board, @postits = [] of Postit); end\nend\n\n# --- Create and Save ---\n\n# A top-level board for \"Work\"\nwork_board = Board.new\nwork_board.sepia_id = \"work_board\"\n\n# A nested board for \"Project X\"\nproject_x_board = Board.new\nproject_x_board.sepia_id = \"project_x\" # This ID is only used for top-level objects\n\n# Create some Post-its\npostit1 = Postit.new(\"Finish the report\")\npostit1.sepia_id = \"report_postit\"\npostit2 = Postit.new(\"Review the code\")\npostit2.sepia_id = \"code_review_postit\"\n\n# Assemble the structure\nproject_x_board.postits &lt;&lt; postit2\nwork_board.boards &lt;&lt; project_x_board\nwork_board.postits &lt;&lt; postit1\n\n# Save the top-level board. This will recursively save all its contents.\nwork_board.save\n\n# --- Load ---\n\nloaded_work_board = Board.load(\"work_board\").as(Board)\n\nputs loaded_work_board.postits[0].text # =&gt; \"Finish the report\"\nputs loaded_work_board.boards[0].postits[0].text # =&gt; \"Review the code\"\n</code></pre><p>And it produces this tree on disk:</p><pre><code>./_data\n├── Board\n│   └── work_board\n│       ├── boards\n│       │   └── project_x\n│       │       └── postits\n│       │           └── 0 -&gt; ./_data/Postit/code_review_postit\n│       └── postits\n│             └── 0 -&gt; ./_data/Postit/report_postit\n└── Postit\n    ├── code_review_postit\n    └── report_postit\n</code></pre><p>You can nest containers all you want, some bits are to be implemented (like preserving order when roundtripping an array) and files with data are deduplicated (they have a canonical location and are symlinked to all the places where they are referenced)</p>","contentLength":2882,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"The true cost of parsing Crystal source code","url":"https://forum.crystal-lang.org/t/the-true-cost-of-parsing-crystal-source-code/8185","date":1750971822,"author":"HertzDevil","guid":29,"unread":true,"content":"<p>Passing  to Crystal when building or running any source code gives you a list of compilation stages and their times elapsed, the first stage being . Most of the time, this stage takes less than 1 , even when rebuilding a large codebase like the compiler itself. This is naturally impossible, no matter how fast your computer runs.</p><p>The reason here is that <a href=\"https://github.com/crystal-lang/crystal/blob/34875ff3fce637b73712090eba4375bc96d80498/src/compiler/crystal/compiler.cr#L294-L311\" rel=\"noopener nofollow ugc\">the scope of the stage is very small</a>. It measures only the time taken to parse the entry points given on the command line, not the time taken for required files; they are parsed as <a href=\"https://github.com/crystal-lang/crystal/blob/34875ff3fce637b73712090eba4375bc96d80498/src/compiler/crystal/semantic/semantic_visitor.cr#L87-L104\" rel=\"noopener nofollow ugc\"> nodes are visited by the top-level visitor</a>, meaning all that elapsed time counts towards the  stage instead. Knowing that all the parsing goes through , here is a rudimentary patch that prints the total time taken for all invocations of that method:</p><pre data-code-wrap=\"crystal\"><code>module Crystal\n  class Parser\n    class_property elapsed = Time::Span.zero\n\n    def parse\n      t0 = Time.monotonic\n      begin\n        previous_def\n      ensure\n        t1 = Time.monotonic\n        Parser.elapsed += t1 - t0\n      end\n    end\n  end\n\n  class Compiler\n    private def print_codegen_stats(units)\n      return unless @progress_tracker.stats?\n      puts \"Parse total: #{Parser.elapsed}\"\n      previous_def\n    end\n  end\nend\n</code></pre><p>We then build an empty file with , meaning the prelude is solely responsible for all the parsing. On Windows, a typical run looks like this:</p><pre><code>Parse:                             00:00:00.000625400 (   1.16MB)\nSemantic (top level):              00:00:00.371690400 ( 129.64MB)\nSemantic (new):                    00:00:00.001411500 ( 129.64MB)\nSemantic (type declarations):      00:00:00.022352500 ( 129.64MB)\nSemantic (abstract def check):     00:00:00.008010900 ( 145.64MB)\nSemantic (restrictions augmenter): 00:00:00.006648800 ( 145.64MB)\nSemantic (ivars initializers):     00:00:00.095378200 ( 145.70MB)\nSemantic (cvars initializers):     00:00:00.003065200 ( 145.70MB)\nSemantic (main):                   00:00:00.212487200 ( 193.82MB)\nSemantic (cleanup):                00:00:00.000268600 ( 193.82MB)\nSemantic (recursive struct check): 00:00:00.000578700 ( 193.82MB)\nCodegen (crystal):                 00:00:00.199303900 ( 193.82MB)\nCodegen (bc+obj):                  00:00:00.182948200 ( 209.82MB)\nCodegen (linking):                 00:00:00.714077300 ( 209.82MB)\nParse total: 00:00:00.268039300\n</code></pre><p>0.27 second, or over 70% of the top-level phase, is spent on parsing source code. It may seem little compared to the main and codegen phases, but definitely contributes to the slowless perceived by some newcomers running their first Hello World program and other short scripts. It also dominates compiler components that only require the top-level semantic pass, like the docs generator and the hierarchy tool. Below is a flame graph showing the same symptom: (this is done on Debian WSL)</p><p>The graph is focused on the outermost stack frame involving the top-level visitor, and all the highlighted frames are instance methods of . They indeed occupy the majority of the top-level phase.</p><p>Traditionally, much of the work on improving compilation times has been directed at the codegen phases, and there was little attention to the parser. There are probably many missed optimization opportunities here, and we may want better reporting facilities for  too, not least because the stages of interest are not perfectly sequential, i.e. parsing could happen in the middle of the main phase too for macro methods referring to the  macro variable.</p>","contentLength":3451,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Upcoming release 1.17.0","url":"https://forum.crystal-lang.org/t/upcoming-release-1-17-0/8184","date":1750935246,"author":"straight-shoota","guid":28,"unread":true,"content":"<p>The next Crystal release,  is scheduled for .</p><p>As usual, this is precluded by a two-week feature , starting . We’ll be using this time until the release to consolidate the changes and fix bugs.</p><ul><li> only on TTY by default</li><li>New compiler tool </li><li>Stabilized execution contexts</li></ul><p>There will be further additions to these resources as we merge additional changes.</p><p>The nightly builds serve as previews of the upcoming release. Please <strong>test your code base against nightly builds</strong> and report any regressions <img src=\"https://emoji.discourse-cdn.com/google_classic/person_bowing.png?v=14\" title=\":person_bowing:\" alt=\":person_bowing:\" loading=\"lazy\" width=\"20\" height=\"20\"></p>","contentLength":484,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"About openssl signature","url":"https://forum.crystal-lang.org/t/about-openssl-signature/8183","date":1750926074,"author":"Fulgurance","guid":27,"unread":true,"content":"<p>Hi guys, I am actually coding a authenticity check for my package manager, where I will check a package signature.</p><p>What do you suggest me about it? What parameter should I use to generate a very secure private key ?</p>","contentLength":214,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"ToCry a fancy ToDo/Kanban web app","url":"https://forum.crystal-lang.org/t/tocry-a-fancy-todo-kanban-web-app/8181","date":1750639198,"author":"ralsina","guid":26,"unread":true,"content":"<p>I got sick of limitations in a ToDO app I was using and thought “this can’t be too hard, can it?” and it wasn’t.</p><p>Will in the future make it multiboard/multiuser but is currently “Just Enough App®️” for me</p>","contentLength":218,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Upload image failed use HTTP::Client but test with postman work","url":"https://forum.crystal-lang.org/t/upload-image-failed-use-http-client-but-test-with-postman-work/8171","date":1750308882,"author":"zw963","guid":25,"unread":true,"content":"<p>Following is my code (I need form_data to upload a file, but for now,  test with a <code>source:  \"https://image_url\"</code> is enough.</p><pre><code>post \"/api/upload\" do\n    # file_path = params.from_multipart.last[\"source\"].path\n\n    io = IO::Memory.new\n\n    form_data = HTTP::FormData::Builder.new(io)\n    form_data.field(\"key\", \"my_key\")\n    form_data.field(\"source\", \"https://avatars.githubusercontent.com/u/549126?s=96&amp;v=4\")\n\n    response = HTTP::Client.post(\n      url: \"https://freeimage.host/api/1/upload\",\n      headers: HTTP::Headers{\"Content-Type\" =&gt; \"multipart/form-data\"},\n      form: io\n    )\n\n    pp! response\n    if response.success?\n      image_url = JSON.parse(response.body).dig(\"image\", \"display_url\")\n      json({image_url: image_url}, HTTP::Status::OK)\n    else\n      json(HTTP::Status::BAD_REQUEST)\n    end\n  end\n</code></pre><p>When I upload,  I always get error like this:</p><pre><code>{\\\"status_code\\\":400,\\\"error\\\":{\\\"message\\\":\\\"Invalid API v1 key.\\\",\\\"code\\\":100},\\\"status_txt\\\":\\\"Bad Request\\\"}\"\n</code></pre><p>But if i test use a tool like postman, it works (check following screenshot)</p><p>Following is the screenshot of API page</p><blockquote><p>Either a image URL or a base64 encoded image string. You can also use FILES[“source”] in your request.</p></blockquote><p>What is the means of <code>FILES[\"source\"] in your request</code>, how to do that use ?</p><p><small>16 posts - 5 participants</small></p>","contentLength":1290,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Mixing Crystal with Go and Exlixr","url":"https://forum.crystal-lang.org/t/mixing-crystal-with-go-and-exlixr/8169","date":1750269229,"author":"jzakiya","guid":24,"unread":true,"content":"<img width=\"420\" height=\"420\" src=\"https://canada1.discourse-cdn.com/flex036/uploads/crystal_lang/original/2X/0/0d850b3dfa0209617548dd4ea67b6067162cb64f.png\" data-dominant-color=\"696969\"><p>At Mozi, we needed to connect a new Elixir Phoenix LiveView app to an existing Go backend. This is how we did it.  …</p>","contentLength":118,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"A blog post about using Google Sheets API with Crystal","url":"https://forum.crystal-lang.org/t/a-blog-post-about-using-google-sheets-api-with-crystal/8157","date":1749833904,"author":"Maroo-b","guid":23,"unread":true,"content":"<p>I just published a new blog post on using the <strong>Google Sheets API with Crystal</strong> — it covers the basics of setting things up, handling authentication, and some example code to read/write data.</p><p>I’d appreciate your feedback on the code and structure. I’m particularly interested in best practices for Crystal code.</p><p>Thanks in advance — always looking to learn and refine! <img src=\"https://emoji.discourse-cdn.com/google_classic/folded_hands.png?v=14\" title=\":folded_hands:\" alt=\":folded_hands:\" loading=\"lazy\" width=\"20\" height=\"20\"></p>","contentLength":371,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Install on MacOS 10.13 (High Sierra)","url":"https://forum.crystal-lang.org/t/install-on-macos-10-13-high-sierra/8155","date":1749832297,"author":"procursor","guid":22,"unread":true,"content":"<p>What is the last known Crystal version that works under High Sierra?</p><p>So that I just download precompiled binary from releases which is probably my best option.</p><p>Is it possible to build the latest and greatest preferably from MacPorts (since I have already downloaded and built all toolchain and libraries needed except for Crystal itself)?</p>","contentLength":336,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Do channels need to be manually closed?","url":"https://forum.crystal-lang.org/t/do-channels-need-to-be-manually-closed/8151","date":1749754027,"author":"syeopite","guid":21,"unread":true,"content":"<p>A bit of a dumb question but should channels be explicitly closed after you’re done using them, or is that something the GC will take care of? My instincts are telling me yes but I also do frequently see code that doesn’t explicitly close any of the channels it creates.</p>","contentLength":274,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null},{"title":"Catch on nested macros","url":"https://forum.crystal-lang.org/t/catch-on-nested-macros/8150","date":1749751282,"author":"wolfgang371","guid":20,"unread":true,"content":"<p>Dear all, I just had a little surprise (at least to me) that for macro nesting you don’t need to have a  inside a  definition, but this is enough already…</p><pre data-code-wrap=\"crystal\"><code>{% if true %}\n\n# this also counts as a nested macro and needs escaping!\nmacro uint64_from_letters(str)\n    \\{% value = 0_u64 %}\n    \\{% for c in str.chars %}\n        \\{% value = (value &lt;&lt; 8) | (c.ord) %}\n    \\{% end %}\n    \\{{ value }}\nend\n\n{% end %}\n\np uint64_from_letters(\"12345678\")\n</code></pre><p>… and needs escaping. If you don’t - you get misleading error messages like</p><pre data-code-wrap=\"console\"><code>In x.cr:15:17\n\n 15 | {% for c in str.chars %}\n                  ^--\nError: undefined macro variable 'str'\n</code></pre><p>No big deal, just unexpected…</p>","contentLength":660,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null}],"tags":["community"]}